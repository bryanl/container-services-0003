---
- name: add docker key
  apt_key: keyserver=p80.pool.sks-keyservers.net id=58118E89F3A912897C070ADBF76221572C52609D

- name: add docker repository
  apt_repository: repo="deb https://apt.dockerproject.org/repo ubuntu-trusty main" update_cache=yes state=present

- name: add haproxy ppa
  apt_repository: repo="ppa:vbernat/haproxy-1.5" update_cache=yes state=present

- name: install packages
  apt: name={{ item }} state=present cache_valid_time=3600
  with_items:
    - docker-engine=1.9.1-0~trusty
    - python-dev
    - python-setuptools

- name: install pip
  easy_install: name=pip

- name: install docker-py
  pip: name=docker-py version=1.7.0

- name: bootstrap docker upstart configuration
  template: src=etc/init/docker-bootstrap.conf.j2 dest=/etc/init/docker-bootstrap.conf
  notify:
    - restart bootstrap docker

- name: bootstrap docker defaults
  template: src=etc/default/docker-bootstrap.j2 dest=/etc/default/docker-bootstrap
  notify:
    - restart bootstrap docker

- name: start docker-bootstrap service
  service: name=docker-bootstrap state=started

- debug: msg={{ etcd_env }}
  when: inventory_hostname in groups['master']

- name: etcd
  when: inventory_hostname in groups['master']
  docker:
    docker_url: unix:///var/run/docker-bootstrap.sock
    restart_policy: on-failure
    net: host
    image: gcr.io/google_containers/etcd-amd64:2.2.1
    command: /usr/local/bin/etcd
    env: "{{ etcd_env }}"



